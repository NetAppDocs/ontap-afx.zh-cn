---
sidebar: sidebar 
permalink: protect-data/snapshot-replication.html 
keywords: afx, afx system, manage replication, manage snapshot replication 
summary: 快照复制是将 AFX 系统上的一致性组复制到地理位置较远的位置的过程。初始复制之后，一致性组的更改将根据复制策略复制到远程位置。复制的一致性组可用于灾难恢复或数据迁移。 
---
= 管理 AFX 存储系统上的快照复制
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
快照复制是将 AFX 系统上的一致性组复制到地理位置较远的位置的过程。初始复制之后，一致性组的更改将根据复制策略复制到远程位置。复制的一致性组可用于灾难恢复或数据迁移。

要设置快照复制，您需要在 AFX 存储系统和远程位置之间建立复制关系。复制关系由复制策略控制。在集群设置期间创建复制所有快照的默认策略。您可以使用默认策略，也可以选择创建新策略。



== 步骤 1：创建集群对等关系

在通过将数据复制到远程集群来保护数据之前，您需要在本地和远程集群之间创建集群对等关系。

.开始之前
AFX 系统与其他ONTAP系统的集群对等的先决条件相同。link:https://docs.netapp.com/us-en/ontap/peering/prerequisites-cluster-peering-reference.html["查看集群对等连接的先决条件"^] 。

.步骤
. 在本地集群上，在系统管理器中，选择“集群”>“设置”。
. 在“集群间设置”下，选择“集群对等体”旁边的image:icon_kabob.gif["三个垂直的蓝点"]，然后选择*添加集群对等点*。
. 选择*启动远程集群*；这将生成一个密码，您将使用该密码来对远程集群进行身份验证。
. 生成远程集群的密码后，将其粘贴到本地集群的 *Passphrase* 下。
. 选择image:icon_add.gif["蓝色加号，后跟蓝色字母“add”"]；然后输入集群间网络接口 IP 地址。
. 选择*启动集群对等*。


.下一步是什么？
您已将本地 AFX 集群与远程集群对等。您现在可以创建复制关系。



== 步骤 2：（可选）创建复制策略

快照复制策略定义何时将在 AFX 集群上执行的更新复制到远程站点。

.步骤
. 在系统管理器中，选择*保护>策略*；然后选择*复制策略*。
. 选择image:icon_add_blue_bg.png["蓝色矩形框内有一个加号，后面跟着白色字母“add”"]。
. 输入复制策略的名称或接受默认名称；然后输入描述。
. 选择*政策范围*。
+
如果要将复制策略应用于整个集群，请选择*集群*。如果您希望复制策略仅应用于特定存储虚拟机中的卷，请选择“*存储虚拟机*”。

. 选择*政策类型*。
+
[cols="2,6a"]
|===
| 选项 | 步骤 


| 将数据写入源后复制到远程站点。  a| 
.. 选择*异步*。
.. 在*从源传输快照*下，接受默认传输计划或选择其他计划。
.. 选择传输所有快照或创建规则来确定要传输哪些快照。
.. 可选地，启用网络压缩。




| 同时将数据写入源站点和远程站点。  a| 
.. 选择*同步*。


|===
. 选择*保存*。


.下一步是什么？
您已创建复制策略，现在准备在 AFX 系统和远程位置之间创建复制关系。



== 步骤 3：创建复制关系

快照复制关系在您的 AFX 系统和远程位置之间建立连接，以便您可以将一致性组复制到远程集群。复制的一致性组可用于灾难恢复或数据迁移。

为了防止勒索软件攻击，当您设置复制关系时，您可以选择锁定目标快照。锁定的快照不会被意外或恶意删除。如果卷受到勒索软件攻击，您可以使用锁定的快照来恢复数据。

.开始之前
如果要锁定目标快照，则必须link:../secure-data/ransomware-protection.html#initialize-the-snaplock-compliance-clock["初始化快照合规时钟"]在创建复制关系之前。

创建具有或不具有锁定目标快照的复制关系。

[role="tabbed-block"]
====
.带有锁定快照
--
.步骤
. 在系统管理器中，选择*保护>一致性组*。
. 选择一个一致性组。
. 选择image:icon_kabob.gif["三个垂直的蓝点"]；然后选择*保护*。
. 在*远程保护*下，选择*复制到远程集群*。
. 选择*复制策略*。
+
您必须选择一个_vault_复制策略。

. 选择*目标设置*。
. 选择*锁定目标快照以防止删除*
. 输入最长和最短数据保留期。
. 要延迟数据传输的开始，请取消选择*立即开始传输*。
+
默认情况下，初始数据传输立即开始。

. 或者，要覆盖默认传输计划，请选择“*目标设置*”，然后选择“*覆盖传输计划*”。
+
您的转机时间安排必须至少为 30 分钟才能获得支持。

. 选择*保存*。


--
.未锁定快照
--
.步骤
. 在系统管理器中，选择*保护>复制*。
. 选择创建与本地目标或本地源的复制关系。
+
[cols="2,2"]
|===
| 选项 | 步骤 


| 当地目的地  a| 
.. 选择*本地目的地*，然后选择image:icon_replicate_blue_bg.png["蓝色背景的矩形，白色字母“复制”"]。
.. 搜索并选择源一致性组。
+
_source_ 一致性组是指您想要复制的本地集群上的一致性组。





| 本地来源  a| 
.. 选择“本地来源”，然后选择image:icon_replicate_blue_bg.png["蓝色背景的矩形，白色字母“复制”"]。
.. 搜索并选择源一致性组。
+
_source_ 一致性组是指您想要复制的本地集群上的一致性组。

.. 在*复制目标*下，选择要复制到的集群；然后选择存储虚拟机。


|===
. 选择复制策略。
. 要延迟数据传输的开始，请选择*目标设置*；然后取消选择*立即开始传输*。
+
默认情况下，初始数据传输立即开始。

. 或者，要覆盖默认传输计划，请选择“*目标设置*”，然后选择“*覆盖传输计划*”。
+
您的转机时间安排必须至少为 30 分钟才能获得支持。

. 选择*保存*。


--
====
.下一步是什么？
现在您已经创建了复制策略和关系，您的初始数据传输将按照复制策略中的定义开始。您可以选择测试复制故障转移，以验证如果 AFX 系统离线，是否可以成功进行故障转移。



== 步骤 4：测试复制故障转移

或者，如果源集群处于离线状态，请验证您是否可以成功从远程集群上的复制卷提供数据。

.步骤
. 在系统管理器中，选择*保护>复制*。
. 将鼠标悬停在要测试的复制关系上，然后选择image:icon_kabob.gif["三个垂直的蓝点"]。
. 选择*测试故障转移*。
. 输入故障转移信息，然后选择*测试故障转移*。


.下一步是什么？
现在您的数据已通过快照复制进行灾难恢复保护，您应该link:../secure-data/encrypt-data-at-rest.html["加密静态数据"]这样，如果您的 AFX 系统中的磁盘被重新利用、退回、放错地方或被盗，它就无法被读取。
